# HR Open Platform - Техническая документация

## Обзор проекта

HR Open Platform - это полнофункциональная HR-платформа для управления вакансиями, резюме, общения между кандидатами и работодателями. Система включает в себя видеозвонки с транскрипцией, систему подбора кандидатов с использованием ИИ, чаты и управление компаниями.

## Архитектура системы

### Общая архитектура
- **Frontend**: React + TypeScript приложение
- **Backend**: Go микросервис с REST API
- **База данных**: PostgreSQL с схемной организацией
- **Файловое хранилище**: MinIO (S3-совместимое)
- **ИИ интеграция**: DeepSeek API для анализа резюме
- **Real-time коммуникация**: WebSocket для чатов и видеозвонков

### Технологический стек

#### Backend (Go)
- **Framework**: Chi router для HTTP роутинга
- **ORM**: sqlc для генерации типобезопасного кода из SQL
- **База данных**: PostgreSQL с pgx драйвером
- **Миграции**: goose для управления схемой БД
- **WebSocket**: gorilla/websocket для real-time связи
- **Файлы**: MinIO SDK для S3-совместимого хранилища
- **Логирование**: slog (стандартная библиотека Go 1.21+)
- **Аутентификация**: JWT токены
- **Валидация**: встроенная валидация Go

#### Frontend (React + TypeScript)
- **UI Framework**: Material-UI (MUI) компоненты
- **Состояние**: React Query (TanStack Query) для серверного состояния
- **Роутинг**: React Router v6
- **HTTP клиент**: Автогенерированный из OpenAPI
- **WebSocket**: Нативный WebSocket API
- **WebRTC**: Нативный WebRTC API для видеозвонков
- **Speech Recognition**: Web Speech API

#### Инфраструктура
- **Контейнеризация**: Docker и Docker Compose
- **Кодогенерация**: oapi-codegen для Go и openapi-typescript-codegen для TypeScript
- **Документация API**: OpenAPI 3.0 спецификации

## Структура проекта

```
HROpenPlatform/
├── api/                           # OpenAPI спецификации
│   ├── auth.yaml                  # Аутентификация
│   ├── profile.yaml               # Профили пользователей
│   ├── company.yaml               # Компании
│   ├── job.yaml                   # Вакансии
│   ├── cv.yaml                    # Резюме и база резюме
│   ├── chat.yaml                  # Чаты
│   └── call.yaml                  # Видеозвонки
├── backend/
│   ├── migrations/                # Миграции базы данных
│   └── platform_service/         # Основной сервис
│       ├── internal/
│       │   ├── config/            # Конфигурация
│       │   ├── models/            # Модели данных
│       │   ├── repository/        # Слой доступа к данным
│       │   ├── service/           # Бизнес-логика
│       │   └── router/            # HTTP роутеры и хендлеры
│       └── oapi-codegen-configs/  # Конфигурации генератора кода
└── frontend/
    ├── src/
    │   ├── api/                   # Автогенерированные API клиенты
    │   ├── components/            # React компоненты
    │   ├── pages/                 # Страницы приложения
    │   ├── hooks/                 # Custom React hooks
    │   └── contexts/              # React контексты
    └── public/                    # Статические файлы
```

## База данных

### Схемная организация
PostgreSQL база данных организована по схемам для логического разделения:

- **auth**: Аутентификация и сессии
- **profile**: Профили пользователей
- **company**: Компании и опыт работы
- **cv**: Резюме и база резюме
- **job**: Вакансии и отклики
- **chat**: Чаты и сообщения
- **call**: Видеозвонки и транскрипты

### Миграции
Используется goose для управления миграциями. Основные миграции:
- `20250104210300_init.sql` - Начальная схема (auth, profile, company)
- `20250518224655_grants.sql` - Права доступа для backend пользователя
- `20250530223859_chats.sql` - Схема чатов
- `20250531000000_calls.sql` - Схема видеозвонков
- `20250601000000_jobs.sql` - Схема вакансий
- `20250602000000_resume_database.sql` - База резюме

## API эндпоинты и бизнес-логика

### Модуль аутентификации (auth.yaml)

#### POST /api/v1/auth/register
**Назначение**: Регистрация нового пользователя
**Бизнес-логика**:
1. Валидация входных данных (email, пароль, подтверждение пароля)
2. Проверка требований к паролю (SHA-256 хеширование на клиенте)
3. Проверка на существование пользователя с таким email
4. Хеширование пароля с bcrypt
5. Создание записи в `profile.profiles`
6. Генерация JWT токенов (access + refresh)
7. Создание сессии в `auth.sessions`

**Технические детали**:
- Пароль должен быть захеширован SHA-256 на клиенте
- bcrypt для серверного хеширования
- JWT токены с настраиваемым TTL
- Сохранение метаданных сессии (IP, User-Agent)

#### POST /api/v1/auth/login
**Назначение**: Аутентификация пользователя
**Бизнес-логика**:
1. Поиск пользователя по email
2. Проверка активности аккаунта
3. Сравнение паролей через bcrypt
4. Генерация новых JWT токенов
5. Создание новой сессии

#### POST /api/v1/auth/refresh
**Назначение**: Обновление access токена
**Бизнес-логика**:
1. Валидация refresh токена
2. Поиск активной сессии пользователя
3. Сравнение токенов
4. Генерация нового access токена
5. Возврат токенов (refresh остается тот же)

#### POST /api/v1/auth/logout
**Назначение**: Выход из системы
**Бизнес-логика**:
1. Валидация access токена
2. Поиск активной сессии
3. Деактивация сессии в БД

#### POST /api/v1/auth/restore
**Назначение**: Восстановление пароля (заглушка)
**Статус**: Не реализовано

### Модуль профилей (profile.yaml)

#### GET /api/v1/profile
**Назначение**: Получение собственного профиля
**Бизнес-логика**:
1. Извлечение userGUID из JWT токена
2. Поиск профиля в БД
3. Получение ссылки на CV из `cv.cv`
4. Объединение данных и возврат

#### PUT /api/v1/profile
**Назначение**: Обновление собственного профиля
**Бизнес-логика**:
1. Валидация входных данных
2. Получение существующего профиля
3. Обновление полей профиля
4. Сохранение ссылки на CV (если передана)
5. Возврат обновленного профиля

#### GET /api/v1/profile/{guid}
**Назначение**: Просмотр чужого профиля
**Бизнес-логика**:
1. Поиск профиля по GUID
2. Получение ссылки на CV
3. Возврат публичной информации

#### GET /api/v1/profile/search
**Назначение**: Поиск профилей по ФИО
**Бизнес-логика**:
1. Поиск по частичному совпадению в поле description
2. Возврат сокращенной информации о профилях
3. Поддержка пагинации

#### GET /api/v1/profile/experience
**Назначение**: Получение опыта работы
**Бизнес-логика**:
1. Поиск записей в `company.profile_company`
2. Объединение с данными компаний
3. Возврат списка опыта работы

#### PUT /api/v1/profile/experience
**Назначение**: Обновление опыта работы
**Бизнес-логика**:
1. Валидация данных
2. Обновление или создание записи опыта
3. Связывание с компанией по GUID

#### DELETE /api/v1/profile/experience
**Назначение**: Удаление записи опыта работы
**Параметры**: guid в query параметрах

### Модуль компаний (company.yaml)

#### GET /api/v1/company
**Назначение**: Получение списка всех компаний
**Бизнес-логика**:
1. Поиск всех активных компаний в `company.companies`
2. Поддержка поиска по названию (ILIKE)
3. Пагинация результатов
4. Возврат списка с основной информацией

#### POST /api/v1/company
**Назначение**: Создание новой компании
**Бизнес-логика**:
1. Валидация входных данных
2. Проверка уникальности названия компании
3. Создание записи в `company.companies`
4. Установка создателя как администратора

#### GET /api/v1/company/{guid}
**Назначение**: Получение детальной информации о компании
**Бизнес-логика**:
1. Поиск компании по GUID
2. Получение списка сотрудников из `company.profile_company`
3. Объединение с профилями пользователей
4. Возврат полной информации

#### PUT /api/v1/company/{guid}
**Назначение**: Обновление информации о компании
**Бизнес-логика**:
1. Проверка прав доступа (только создатель)
2. Валидация данных
3. Обновление записи в БД

#### DELETE /api/v1/company/{guid}
**Назначение**: Удаление компании
**Бизнес-логика**:
1. Проверка прав доступа
2. Проверка на связанные записи
3. Мягкое или жесткое удаление

### Модуль CV и базы резюме (cv.yaml)

#### POST /api/v1/cv/upload
**Назначение**: Загрузка персонального резюме
**Бизнес-логика**:
1. Валидация файла (формат, размер)
2. Генерация уникального имени файла
3. Загрузка в MinIO storage
4. Создание публичной ссылки
5. Сохранение ссылки в `cv.cv`

**Технические детали**:
- Поддержка форматов: PDF, DOC, DOCX
- Ограничение размера файла: 10MB
- S3-совместимое хранилище MinIO

#### GET /api/v1/cv/{filename}
**Назначение**: Скачивание файла резюме
**Бизнес-логика**:
1. Поиск файла в MinIO storage
2. Проверка прав доступа
3. Возврат файла с корректными заголовками

#### POST /api/v1/cv/database/upload
**Назначение**: Загрузка архива с базой резюме
**Бизнес-логика**:
1. Валидация ZIP архива (размер до 100MB)
2. Распаковка архива в памяти
3. Обработка каждого файла:
   - Проверка формата (PDF, TXT, DOC, DOCX)
   - Извлечение текста из файла
   - Загрузка файла в MinIO
   - Анализ через DeepSeek API
   - Сохранение в `cv.resume_database`
4. Возврат статистики обработки

**Технические детали**:
- Извлечение текста из PDF через regex паттерны
- Извлечение текста из DOCX через XML парсинг
- Интеграция с DeepSeek API для анализа
- Полнотекстовый поиск на русском языке

#### GET /api/v1/cv/database
**Назначение**: Получение базы резюме пользователя
**Бизнес-логика**:
1. Поиск записей пользователя в `cv.resume_database`
2. Поддержка пагинации
3. Сортировка по дате создания
4. Возврат метаданных и анализа

#### POST /api/v1/cv/database/match/{job_id}
**Назначение**: Подбор кандидатов из базы резюме
**Бизнес-логика**:
1. Проверка прав доступа (только автор вакансии)
2. Получение описания вакансии
3. Получение всех резюме пользователя
4. Отправка данных в DeepSeek API для сопоставления
5. Возврат топ-5 кандидатов с оценками и обоснованием

**Интеграция с DeepSeek API**:
- Анализ резюме: извлечение ФИО, возраста, опыта
- Сопоставление кандидатов: оценка соответствия 1-100
- Русскоязычные промпты для точного анализа

### Модуль вакансий (job.yaml)

#### GET /api/v1/job
**Назначение**: Получение списка всех активных вакансий
**Бизнес-логика**:
1. Поиск активных вакансий в `job.jobs`
2. Полнотекстовый поиск по названию и описанию
3. Пагинация результатов
4. Сортировка по дате создания

#### POST /api/v1/job
**Назначение**: Создание новой вакансии
**Бизнес-логика**:
1. Валидация входных данных
2. Установка автора вакансии
3. Создание записи со статусом "active"
4. Возврат созданной вакансии

#### GET /api/v1/job/{job_id}
**Назначение**: Получение детальной информации о вакансии
**Бизнес-логика**:
1. Поиск вакансии по ID
2. Определение роли пользователя (автор/кандидат)
3. Проверка статуса отклика пользователя
4. Загрузка откликов (только для автора)
5. Возврат расширенной информации

#### PUT /api/v1/job/{job_id}
**Назначение**: Обновление вакансии
**Бизнес-логика**:
1. Проверка прав доступа (только автор)
2. Валидация изменений
3. Обновление записи в БД

#### DELETE /api/v1/job/{job_id}
**Назначение**: Удаление вакансии
**Ограничения**: Только автор вакансии

#### GET /api/v1/job/my
**Назначение**: Получение собственных вакансий
**Бизнес-логика**:
1. Поиск вакансий по author_id
2. Подсчет откликов для каждой вакансии
3. Возврат с дополнительной статистикой

#### POST /api/v1/job/{job_id}/apply
**Назначение**: Подача отклика на вакансию
**Бизнес-логика**:
1. Проверка статуса вакансии (должна быть активна)
2. Проверка на повторную подачу отклика
3. Проверка, что пользователь не автор вакансии
4. Создание записи в `job.job_applications`

#### GET /api/v1/job/{job_id}/applications
**Назначение**: Получение откликов на вакансию
**Бизнес-логика**:
1. Проверка прав доступа (только автор)
2. Получение откликов с профилями кандидатов
3. Пагинация результатов

#### PUT /api/v1/job/{job_id}/applications/{applicant_id}
**Назначение**: Изменение статуса отклика
**Бизнес-логика**:
1. Проверка прав доступа (только автор вакансии)
2. Обновление статуса (pending/reviewed/accepted/rejected)
3. Возврат обновленного отклика

### Модуль чатов (chat.yaml)

#### GET /api/v1/chat
**Назначение**: Получение списка чатов пользователя
**Бизнес-логика**:
1. Поиск чатов через `chat.chat_users`
2. Получение последнего сообщения для каждого чата
3. Подсчет непрочитанных сообщений
4. Возврат с метаданными участников

#### POST /api/v1/chat
**Назначение**: Создание нового чата
**Бизнес-логика**:
1. Валидация списка участников
2. Проверка существования чата между пользователями
3. Создание записи в `chat.chats`
4. Добавление участников в `chat.chat_users`

#### GET /api/v1/chat/{chat_id}/messages
**Назначение**: Получение сообщений чата
**Бизнес-логика**:
1. Проверка доступа к чату
2. Загрузка сообщений с пагинацией
3. Получение информации об отправителях
4. Сортировка по времени создания

#### POST /api/v1/chat/{chat_id}/messages
**Назначение**: Отправка сообщения
**Бизнес-логика**:
1. Проверка доступа к чату
2. Создание сообщения в `chat.messages`
3. Обновление времени последней активности чата
4. Рассылка через WebSocket

#### GET /api/v1/chat/{chat_id}/ws
**Назначение**: WebSocket соединение для real-time чата
**Бизнес-логика**:
1. Upgrade HTTP соединения до WebSocket
2. Валидация JWT токена из query параметров
3. Подписка на канал чата
4. Обработка входящих сообщений
5. Пересылка специальных сигналов (видеозвонки)

**Технические детали**:
- gorilla/websocket для WebSocket соединений
- In-memory хранение активных соединений
- Автоматическая отписка при разрыве соединения
- Поддержка сигналов видеозвонков

### Модуль видеозвонков (call.yaml)

#### POST /api/v1/call
**Назначение**: Создание нового видеозвонка
**Бизнес-логика**:
1. Валидация списка участников
2. Создание записи в `call.calls` со статусом "active"
3. Добавление участников в `call.call_participants`
4. Создание WebSocket комнаты для звонка
5. Возврат информации о созданном звонке

#### GET /api/v1/call/history
**Назначение**: Получение истории звонков
**Бизнес-логика**:
1. Поиск звонков пользователя через участие
2. Загрузка транскриптов для каждого звонка
3. Объединение с информацией об участниках
4. Пагинация результатов

#### GET /api/v1/call/{call_id}/ws
**Назначение**: WebSocket для видеозвонка и транскрипции
**Бизнес-логика**:
1. Upgrade до WebSocket соединения
2. Добавление в комнату звонка
3. Обработка WebRTC сигналов (offer/answer/candidate)
4. Получение и сохранение транскриптов речи
5. Широковещательная рассылка сигналов

**Поддерживаемые типы сообщений**:
- `webrtc-signal`: WebRTC сигналы для установления соединения
- `speech-transcript`: Транскрипты речи от Speech Recognition API
- `call-end`: Сигнал завершения звонка

**Технические детали**:
- Интеграция с Web Speech Recognition API
- Сохранение транскриптов в `call.transcripts`
- Управление состоянием звонка в памяти
- Автоматическое завершение при отключении всех участников

## Архитектурные паттерны и принципы

### Слоевая архитектура Backend

```
┌─────────────────────────────────────┐
│            HTTP Handlers            │  ← router/
├─────────────────────────────────────┤
│           Business Logic            │  ← service/
├─────────────────────────────────────┤
│           Data Access Layer         │  ← repository/
├─────────────────────────────────────┤
│              Database               │  ← PostgreSQL
└─────────────────────────────────────┘
```

**Router Layer** (`internal/router/`):
- HTTP обработчики для каждого модуля
- Валидация входных данных
- Сериализация/десериализация JSON
- Обработка ошибок и логирование

**Service Layer** (`internal/service/`):
- Бизнес-логика приложения
- Оркестрация вызовов к repository
- Интеграция с внешними сервисами (DeepSeek, MinIO)
- Транзакционная логика

**Repository Layer** (`internal/repository/`):
- Автогенерированный код через sqlc
- Типобезопасные SQL запросы
- Управление транзакциями
- Абстракция доступа к данным

### Middleware и безопасность

#### Аутентификация
```go
// AuthMiddleware - обязательная аутентификация
func AuthMiddleware(cfg *config.Config, log *slog.Logger) MiddlewareFunc

// OptionalAuthMiddleware - опциональная аутентификация
func OptionalAuthMiddleware(cfg *config.Config, log *slog.Logger) MiddlewareFunc
```

**Процесс аутентификации**:
1. Извлечение JWT токена из Authorization заголовка
2. Валидация подписи токена
3. Проверка срока действия
4. Извлечение user_guid и сохранение в контексте

#### CORS
```go
func CORSMiddleware(next http.Handler) http.Handler
```
- Поддержка всех origins в development
- Поддержка всех HTTP методов
- Передача credentials

#### Логирование
```go
// Structured logging с slog
slogchiMW := slogchi.NewWithConfig(h.log.WithGroup("http"), slogchiConfig)
```
- Логирование всех HTTP запросов
- Включение тела запроса/ответа
- Структурированные логи в JSON формате

#### Восстановление от паники
```go
router.Use(middleware.Recoverer)
```
- Graceful обработка паник
- Логирование стека вызовов
- Возврат 500 ошибки

### Управление конфигурацией

```go
type Config struct {
    DatabaseURL        string
    MinIOEndpoint     string
    MinIOAccessKey    string
    MinIOSecretKey    string
    AccessTokenSecret string
    RefreshTokenSecret string
    AccessTokenTTL    int
    RefreshTokenTTL   int
    DeepSeekAPIKey    string
}
```

**Источники конфигурации**:
- Переменные окружения
- Файлы конфигурации
- Значения по умолчанию

### Управление транзакциями

```go
// TxManager обеспечивает консистентность данных
type TxManager interface {
    WithTransaction(ctx context.Context, fn func(context.Context, pgx.Tx) error) error
}
```

**Принципы**:
- Автоматический rollback при ошибках
- Изоляция операций в рамках транзакции
- Consistent read для связанных операций

## Взаимосвязи компонентов

### Интеграция с внешними сервисами

#### DeepSeek API
```go
type DeepSeekService interface {
    AnalyzeResume(ctx context.Context, resumeText string) (*models.ResumeAnalysis, error)
    MatchCandidates(ctx context.Context, jobDescription string, resumes []models.ResumeRecord) ([]models.MatchedCandidate, error)
}
```
- HTTP клиент с таймаутами
- Структурированные промпты на русском языке
- Обработка ошибок API и retry логика

#### MinIO (S3 Storage)
```go
type StorageService interface {
    UploadFile(ctx context.Context, bucketName, objectName string, data []byte, contentType string) (string, error)
    GetFile(ctx context.Context, bucketName, objectName string) ([]byte, error)
    GetFileURL(ctx context.Context, bucketName, objectName string) (string, error)
}
```
- Автоматическое создание bucket'ов
- Генерация публичных URL
- Управление правами доступа

### Real-time коммуникация

#### WebSocket архитектура
```go
// Управление соединениями
type WebSocketConnection struct {
    UserID string
    Send   chan []byte
}

// Комнаты для группировки соединений
type ChatRoom map[string]*WebSocketConnection
type CallRoom map[string]*WebSocketConnection
```

**Жизненный цикл соединения**:
1. HTTP Upgrade до WebSocket
2. Аутентификация через JWT в query params
3. Добавление в соответствующую комнату
4. Обработка входящих сообщений
5. Автоматическая очистка при отключении

#### Интеграция чатов и видеозвонков
- Сигналы видеозвонков передаются через чат WebSocket
- Единая система уведомлений
- Переиспользование соединений

### Frontend архитектура

#### Состояние приложения
```typescript
// Server state - React Query
const { data: jobs } = useQuery(['jobs'], JobService.getJobs)

// Local state - React useState/useReducer
const [selectedJob, setSelectedJob] = useState<Job | null>(null)

// WebSocket state - Custom hooks
const { sendMessage, onMessage } = useWebSocket(chatId)
```

#### API интеграция
```typescript
// Автогенерированные клиенты
import { JobService, ProfileService, ChatService } from '../api'

// Type-safe вызовы с автокомплитом
const jobs = await JobService.getJobs({ limit: 10, offset: 0 })
```

#### WebRTC интеграция
```typescript
// Установка peer соединения
const peerConnection = new RTCPeerConnection(configuration)

// Speech Recognition
const { startListening, transcript } = useSpeechRecognition(onTranscript)
```

## Безопасность

### Аутентификация и авторизация
- JWT токены с RSA подписью
- Separate access/refresh токены
- Session tracking в БД
- IP и User-Agent валидация

### Защита данных
- Хеширование паролей с bcrypt
- SQL инъекции предотвращены через prepared statements
- Валидация всех входных данных
- Санитизация файловых путей

### CORS и CSP
- Настроенные CORS политики
- Content Security Policy заголовки
- Защита от CSRF атак

## Производительность

### База данных
- Индексы на часто используемых полях
- Полнотекстовый поиск для русского языка
- Пагинация всех списковых запросов
- Connection pooling

### Кеширование
- HTTP кеширование статических ресурсов
- In-memory кеширование активных WebSocket соединений
- Кеширование результатов DeepSeek API (потенциально)

### Файловое хранилище
- Прямые ссылки на MinIO для скачивания
- Оптимизированная загрузка больших файлов
- Автоматическая очистка временных файлов

## Развертывание и DevOps

### Docker контейнеризация
```yaml
# docker-compose.yml структура
services:
  postgres:     # База данных
  minio:        # Файловое хранилище  
  backend:      # Go сервис
  frontend:     # React приложение
  nginx:        # Reverse proxy
```

### Кодогенерация
```makefile
# Автоматическая генерация кода
make sqlcgen           # SQL -> Go код
make backend-codegen   # OpenAPI -> Go серверы
make frontend-codegen  # OpenAPI -> TypeScript клиенты
make migrate          # Применение миграций БД
```

### Мониторинг
- Структурированное логирование (JSON)
- HTTP метрики через middleware
- Health check эндпоинт `/ping`
- Database connection monitoring

## Заключение

HR Open Platform представляет собой современную микросервисную архитектуру с четким разделением ответственности между слоями. Ключевые преимущества:

1. **Type Safety**: Автогенерация кода из OpenAPI и SQL схем
2. **Real-time**: WebSocket поддержка для чатов и видеозвонков
3. **AI Integration**: Интеграция с DeepSeek для анализа резюме
4. **Scalability**: Модульная архитектура с возможностью горизонтального масштабирования
5. **Developer Experience**: Автоматизированная кодогенерация и типобезопасность

Система готова к продакшн развертыванию при условии настройки переменных окружения и внешних зависимостей (PostgreSQL, MinIO, DeepSeek API). 